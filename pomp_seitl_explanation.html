<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>The SEITL model in pomp</title>

<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.4.0/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="mfiidd.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">MFIIDD 2023</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="introduction.html">Introduction</a>
</li>
<li>
  <a href="mcmc.html">MCMC</a>
</li>
<li>
  <a href="mcmc_diagnostics.html">Diagnostics</a>
</li>
<li>
  <a href="play_with_seitl.html">Modelling interlude</a>
</li>
<li>
  <a href="mcmc_and_model_comparison.html">Model comparison</a>
</li>
<li>
  <a href="pmcmc.html">Particle MCMC</a>
</li>
<li>
  <a href="ABC.html">ABC</a>
</li>
<li>
  <a href="further_methods.html">Further methods</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="contact.html">
    <span class="fa fa-envelope-o"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/sbfnk/mfiidd">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">The SEITL model in <em>pomp</em></h1>

</div>


<div id="preliminaries" class="section level1">
<h1>Preliminaries</h1>
<pre class="r"><code>## load pomp package
library(&quot;pomp&quot;)
## load Tristan da Cunha data
data(fluTdc1971)</code></pre>
<p>This loads the <code>pomp</code> package, and the Tristan da Cunha data from the <code>fitR</code> package.</p>
</div>
<div id="the-deterministic-skeleton" class="section level1">
<h1>The deterministic skeleton</h1>
<pre class="r"><code>## define deterministic skeleton
seitlDeterSkel &lt;- Csnippet(&quot;
    double trans[5];

    double beta = R0 / D_inf;
    double epsilon = 1 / D_lat;
    double nu = 1 / D_inf;
    double tau = 1 / D_imm;

    double N = S + E + I + T + L;

    trans[0] = beta * I / N * S;
    trans[1] = epsilon * E;
    trans[2] = nu * I;
    trans[3] = alpha * tau * T;
    trans[4] = (1 - alpha) * tau * T;

    DS = -trans[0] + trans[4];
    DE = trans[0] - trans[1];
    DI = trans[1] - trans[2];
    DT = trans[2] - trans[3] - trans[4];
    DL = trans[3];
    DInc = trans[1];
&quot;)</code></pre>
<p>This defines the so-called deterministic skeleton. In <em>pomp</em>, the stochastic and deterministic versions of the same model can be specified in the same <code>pomp</code> object, and then used by different fitting methods. For example, one can get a first approximate fit using a fast method and the deterministic model before performing more computationally extensive methods on the stochastic models around those solutions. The deterministic skeleton defines how the model would behave if there were no noise in the system.</p>
<p>The model code is implemented as C code which is saved as a character string and converted into R code using <code>Csnippet</code>.</p>
<p>The first line</p>
<pre class="c"><code>    double trans[5];</code></pre>
<p>defines an array trans (of <code>double</code>s, or floating point numbers), which will hold 5 elements. These are defined below according to the 5 transitions in the model.</p>
<p>The following section</p>
<pre class="c"><code>    double beta = R0 / D_inf;
    double epsilon = 1 / D_lat;
    double nu = 1 / D_inf;
    double tau = 1 / D_imm;

    double N = S + E + I + T + L;</code></pre>
<p>defines some auxiliary variables, to be used below when defining the transitions.</p>
<p>The following section</p>
<pre class="c"><code>    trans[0] = beta * I / N * S;
    trans[1] = epsilon * E;
    trans[2] = nu * I;
    trans[3] = alpha * tau * T;
    trans[4] = (1 - alpha) * tau * T;</code></pre>
<p>defines the strength of the 5 transitions in the model: infection, incubation, recovery, temporary immunity and long-term immunity.</p>
<p>Lastly, it is defined how the transitions change the compartments:</p>
<pre class="c"><code>    DS = -trans[0] + trans[4];
    DE = trans[0] - trans[1];
    DI = trans[1] - trans[2];
    DT = trans[2] - trans[3] - trans[4];
    DL = trans[3];
    DInc = trans[1];</code></pre>
</div>
<div id="the-stochastic-model" class="section level1">
<h1>The stochastic model</h1>
<pre class="r"><code>## define stochastic model, for use with euler, see ?euler
seitlStochSim &lt;- Csnippet(&quot;
    double rate[5];
    double dN[5];

    double beta = R0 / D_inf;
    double epsilon = 1 / D_lat;
    double nu = 1 / D_inf;
    double tau = 1 / D_imm;

    double N = S + E + I + T + L;

    rate[0] = beta * I / N;
    rate[1] = epsilon;
    rate[2] = nu;
    rate[3] = alpha * tau;
    rate[4] = (1 - alpha) * tau;

    reulermultinom(1, S, &amp;rate[0], dt, &amp;dN[0]);
    reulermultinom(1, E, &amp;rate[1], dt, &amp;dN[1]);
    reulermultinom(1, I, &amp;rate[2], dt, &amp;dN[2]);
    reulermultinom(2, T, &amp;rate[3], dt, &amp;dN[3]);

    S += -dN[0] + dN[4];
    E += dN[0] - dN[1];
    I += dN[1] - dN[2];
    T += dN[2] - dN[3] - dN[4];
    L += dN[3];
    Inc += dN[1];
&quot;)</code></pre>
<p>This defines the stochastic model. This, again, is implemented as C code which is saved as a character string and later converted into R code using <code>Csnippet</code>. It defines transitions which are then used by the <em>pomp</em> function <code>euler</code>, which in turn uses the <a href="http://en.wikipedia.org/wiki/Euler%E2%80%93Maruyama_method">Euler-Maruyama approximation</a> to the full stochastic system. This calculates the number of events happening in a given fixed time step by sampling from a multinomial distribution with the probabilities of each event given by the product of its rate and the time step. This happens in the following four lines of code:</p>
<pre class="c"><code>    reulermultinom(1, S, &amp;rate[0], dt, &amp;dN[0]);
    reulermultinom(1, E, &amp;rate[1], dt, &amp;dN[1]);
    reulermultinom(1, I, &amp;rate[2], dt, &amp;dN[2]);
    reulermultinom(2, T, &amp;rate[3], dt, &amp;dN[3]);</code></pre>
<p>Instead of calculating the rates of transition as in the deterministic skeleton above, <code>reulermultinom</code> draws random numbers from the compartment specified in the second argument to get the number of individuals who transition from that compartment to another one. These numbers are stored in the array <code>N</code>, and the numbers in each compartment adjusted in the following segment of code:</p>
<pre class="c"><code>    S += -dN[0] + dN[4];
    E += dN[0] - dN[1];
    I += dN[1] - dN[2];
    T += dN[2] - dN[3] - dN[4];
    L += dN[3];
    Inc += dN[1];</code></pre>
<p>The number of susceptibles decreases by the number of individuals randomly drawn from <code>S</code> at rate <code>rate[0]</code> (infection rate) and increases by the number of individuals randomly drawn from <code>T</code> at rate <code>rate[4]</code> (rate of loss of temporary immunity), and so on.</p>
</div>
<div id="random-point-observations" class="section level1">
<h1>Random point observations</h1>
<pre class="r"><code>## define sampling random point observations
seitlGenObsPoint &lt;- Csnippet(&quot;
    obs = rpois(rho * Inc);
&quot;)</code></pre>
<p>(you may notice that the function in the example looks slightly different, to prevent numerical problems later)</p>
<p>This, again, defines a character string with C code, to be used with <code>Csnippet</code>. It defines a function to randomly generate point observations from model incidence, like our function <code>rPointObs</code> earlier. In this case, it uses a random draw from a Poisson distribution with mean <code>rho*Inc</code>, and stores it in the variable <code>obs</code>.</p>
</div>
<div id="point-observation-probability-density" class="section level1">
<h1>Point observation probability density</h1>
<pre class="r"><code>## define point observation probability density
seitlPointLike &lt;- Csnippet(&quot;
    lik = dpois(obs, rho * Inc, give_log);
&quot;)</code></pre>
<p>(you may notice that the function in the example looks slightly different, to prevent numerical problems later)</p>
<p>This, again, defines a character string with C code converted ot R using <code>Csnippet</code>. It defines a function to evaluate the probability density of point observations of the model incidence, like our function <code>dPointObs</code> earlier. In this case, it evaluates the probability following a Poisson probability distribution with mean <code>rho * Inc</code> and stores it in the variable <code>lik</code>. It can do both the logged and natural likelihood; which of the two is used will be given by <code>give_log</code>.</p>
</div>
<div id="prior-density" class="section level1">
<h1>Prior density</h1>
<pre class="r"><code>seitlPrior &lt;- Csnippet(&quot;
  lik = dunif(R0, 1, 50, 1) +
          dunif(D_lat, 0, 10, 1) +
          dunif(D_inf, 0, 15, 1) +
          dunif(D_imm, 0, 50, 1) +
          dunif(alpha, 0, 1, 1) +
          dunif(rho, 0, 1, 1);

  lik = give_log ? lik : exp(lik);
&quot;)</code></pre>
<p>This, again, defines a character string with C code converted to R using <code>Csnippet</code>. It defines a function to evaluate the prior probability density of a set of parameters. The first segment of code,</p>
<pre class="c"><code>lik &lt;- dunif(R0, 1, 50, 1) +
  dunif(D_lat, 0, 10, 1) +
  dunif(D_inf, 0, 15, 1) +
  dunif(D_imm, 0, 50, 1) +
  dunif(alpha, 0, 1, 1) +
  dunif(rho, 0, 1, 1)</code></pre>
<p>calculates the logged probability density according to uniform distributions with different bounds (e.g., 1 and 50 for <code>R0</code>), and takes the sum. The last arguments of 1 in <code>dunif</code> indicate that we want the logarithms of the probability densities. The last line,</p>
<pre class="c"><code>lik &lt;- give_log ? lik:exp(lik)</code></pre>
<p>returns the calculated log-likelihood if <code>give_log</code> is 1, and the exponential of that number (that is, the natural likelihood), if it is 0. The value of <code>give_log</code> is set by whichever function calls the snippet.</p>
</div>
<div id="constructing-the-pomp-object" class="section level1">
<h1>Constructing the <code>pomp</code> object</h1>
<pre class="r"><code>seitlPomp &lt;- pomp(
  data = fluTdc1971[, c(&quot;time&quot;, &quot;obs&quot;)],
  skeleton = vectorfield(seitlDeterSkel),
  rprocess = euler(step.fun = seitlStochSim, delta.t = 0.1),
  rmeasure = seitlGenObsPoint,
  dmeasure = seitlPointLike,
  dprior = seitlPrior,
  partrans = parameter_trans(
    log = c(&quot;R0&quot;, &quot;D_inf&quot;, &quot;D_lat&quot;, &quot;D_imm&quot;, &quot;alpha&quot;, &quot;rho&quot;)
  ),
  times = &quot;time&quot;,
  t0 = 1,
  accumvars = &quot;Inc&quot;,
  paramnames = c(&quot;R0&quot;, &quot;D_inf&quot;, &quot;D_lat&quot;, &quot;D_imm&quot;, &quot;alpha&quot;, &quot;rho&quot;),
  statenames = c(&quot;S&quot;, &quot;E&quot;, &quot;I&quot;, &quot;T&quot;, &quot;L&quot;, &quot;Inc&quot;),
  obsnames = c(&quot;obs&quot;)
)</code></pre>
<p>This constructs the pomp object <code>seitlPomp</code> from the C functions defined above. The individual options are:</p>
<pre class="r"><code>data &lt;- fluTdc1971[, c(&quot;time&quot;, &quot;obs&quot;)]</code></pre>
<p>This specifies the data set. We select the two relevant columns, <code>time</code> and <code>obs</code>.</p>
<pre class="r"><code>skeleton &lt;- vectorfield(seitlDeterSkel)</code></pre>
<p>These define the deterministic skeleton, as given by the C code above. If you are interested in an explanation of the <code>vectorfield</code>, see <code>?pomp</code>.</p>
<pre class="r"><code>rprocess &lt;- euler(step.fun = seitlStochSim, delta.t = 0.1
)</code></pre>
<p>This defines the stochastic (random) process, or the function that is used to sample trajectories. In this case, we use the <a href="http://en.wikipedia.org/wiki/Euler%E2%80%93Maruyama_method">Euler-Maruyama method</a> (see above), with the step function given by our C code above, and a time step of <code>delta.t = 0.1</code>.</p>
<pre class="r"><code>rmeasure &lt;- Csnippet(seitlGenObsPoint)
dmeasure &lt;- Csnippet(seitlPointLike)</code></pre>
<p>These define the functions to randomly sample form the measurement process (equivalent to <code>rPointObs</code> earlier in the course) or evaluate the probability density at a measurement point (equivalent to <code>dPointObs</code> earlier in the course).</p>
<pre class="r"><code>times &lt;- &quot;time&quot;
t0 &lt;- 1</code></pre>
<p>These indicate that times in the data set (<code>fluTdc1971</code>) are given by the “time” column, and that the simulations are to start with the initial state at time 1.</p>
<pre class="r"><code>paramnames &lt;- c(&quot;R0&quot;, &quot;D_inf&quot;, &quot;D_lat&quot;, &quot;D_imm&quot;, &quot;alpha&quot;, &quot;rho&quot;)
statenames &lt;- c(&quot;S&quot;, &quot;E&quot;, &quot;I&quot;, &quot;T&quot;, &quot;L&quot;, &quot;Inc&quot;)
obsnames &lt;- c(&quot;obs&quot;)</code></pre>
<p>These define the names of the parameters, states, and the observation variable.</p>
<p><a href="pomp.html#simulating-the-model-and-estimating-the-likelihood">Return</a> to the <em>pomp</em> session.</p>
</div>

&nbsp;
<hr />
<p>This web site and the material contained in it were originally created in support of an annual
  short course
  on <a href="https://www.lshtm.ac.uk/study/courses/short-courses/infectious-diseases-dynamics">
  Model Fitting and Inference for Infectious Disease Dynamics</a> at
  the <a href="https://www.lshtm.ac.uk/">London School of Hygiene & Tropical
  Medicine</a>. All material is under
  a <a href="https://github.com/sbfnk/mfiidd/blob/main/LICENSE">MIT
  license</a>. Please report any issues or suggestions for improvement on the
  corresponding <a href="https://github.com/sbfnk/mfiidd/issues">GitHub
  issue tracker</a>. We are always keen to hear about any uses of the material
  here, so please do get in touch using the <a href="https://github.com/sbfnk/mfiidd/discussions">Discussion
  board</a> if you have any questions
  or ideas, or if you find the material here useful or use it in your own
  teaching.
</p>

&nbsp;<script data-goatcounter="https://mfiidd.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
